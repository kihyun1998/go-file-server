<!DOCTYPE html>
<html>
    <head>
        <title>ê°œë´‰êµíšŒ í¬í† ë¶€ìŠ¤</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    </head>
<body>
    <header class="header">
        <div class="header-logo">
            <img src="/static/asset/logo.png" alt="ì¸ìƒë„¤ì»·" class="logo-image">
        </div>
    </header>

    <div class="container">
        <div class="photo-frame">
            <h1 class="title">ê°œë´‰êµíšŒ í¬í† ë¶€ìŠ¤</h1>
            
            <div class="preview-container">
                <img class="preview-image" id="previewImage" alt="ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°">
                <video class="preview-video" id="previewVideo" controls>
                    ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ ì¬ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>
                <div class="preview-error" id="previewError">
                    ğŸ˜¢ ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
                </div>
                <div class="loading" id="loadingSpinner">
                    ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ğŸ’
                </div>
            </div>
            
            <p class="preview-message" id="previewMessage"></p>
            
            <button class="download-btn photo-btn" id="photoBtn" onclick="downloadFile('images')" disabled>
                ì‚¬ì§„ ë‹¤ìš´ë¡œë“œ ğŸ“¸
            </button>
            <button class="download-btn video-btn" id="videoBtn" onclick="downloadFile('videos')" disabled>
                ë™ì˜ìƒ ë‹¤ìš´ë¡œë“œ ğŸ¥
            </button>
        </div>
    </div>

    <script>
        const IMAGE_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif'];
        const VIDEO_EXTENSIONS = ['mp4', 'avi', 'mov', 'wmv'];
        let currentFileType = null;
        let currentExtension = null;

        async function checkFileExists(type, filename, extensions) {
            for (const ext of extensions) {
                try {
                    const response = await fetch(`/download/${type}/${filename}.${ext}`);
                    if (response.ok) {
                        return { exists: true, extension: ext };
                    }
                } catch (error) {
                    console.log(`Failed to check .${ext} file:`, error);
                }
            }
            return { exists: false };
        }

        async function loadPreview() {
            const pathParts = window.location.pathname.split('/');
            const filename = pathParts[pathParts.length - 1];
            
            const previewImage = document.getElementById('previewImage');
            const previewVideo = document.getElementById('previewVideo');
            const previewError = document.getElementById('previewError');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const photoBtn = document.getElementById('photoBtn');
            const videoBtn = document.getElementById('videoBtn');
            const previewMessage = document.getElementById('previewMessage');

            previewImage.style.display = 'none';
            previewVideo.style.display = 'none';
            previewError.style.display = 'none';
            loadingSpinner.style.display = 'block';
            photoBtn.disabled = true;
            videoBtn.disabled = true;
            photoBtn.classList.remove('active');
            videoBtn.classList.remove('active');

            // ì´ë¯¸ì§€ ì²´í¬
            const imageResult = await checkFileExists('images', filename, IMAGE_EXTENSIONS);
            if (imageResult.exists) {
                previewImage.src = `/download/images/${filename}.${imageResult.extension}`;
                previewImage.onload = () => {
                    previewImage.style.display = 'block';
                    loadingSpinner.style.display = 'none';
                    photoBtn.disabled = false;
                    photoBtn.classList.add('active');
                    previewMessage.textContent = 'ì‚¬ì§„ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’';
                    currentFileType = 'images';
                    currentExtension = imageResult.extension;
                };
                previewImage.onerror = () => {
                    showError();
                };
                return;
            }

            // ë¹„ë””ì˜¤ ì²´í¬
            const videoResult = await checkFileExists('videos', filename, VIDEO_EXTENSIONS);
            if (videoResult.exists) {
                previewVideo.src = `/download/videos/${filename}.${videoResult.extension}`;
                previewVideo.style.display = 'block';
                loadingSpinner.style.display = 'none';
                videoBtn.disabled = false;
                videoBtn.classList.add('active');
                previewMessage.textContent = 'ë™ì˜ìƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ’';
                currentFileType = 'videos';
                currentExtension = videoResult.extension;
                return;
            }

            showError();
        }

        function showError() {
            const previewError = document.getElementById('previewError');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const previewMessage = document.getElementById('previewMessage');
            
            previewError.style.display = 'block';
            loadingSpinner.style.display = 'none';
            previewMessage.textContent = 'íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢';
        }

        async function downloadFile(type) {
            if (currentFileType !== type) return;
            
            const pathParts = window.location.pathname.split('/');
            const filename = pathParts[pathParts.length - 1];
            
            const a = document.createElement('a');
            a.href = `/download/${type}/${filename}.${currentExtension}`;
            a.download = `${filename}.${currentExtension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì‹œì‘
        window.onload = loadPreview;
    </script>
</body>
</html>